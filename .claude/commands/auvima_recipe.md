# /auvima.recipe

配方管理命令 - 创建、更新和管理可复用的浏览器操作配方

## 用法

```
/auvima.recipe create <操作描述>
/auvima.recipe update <配方名>
/auvima.recipe list
```

## 子命令

### create - 创建新配方

通过交互式探索创建新的操作配方。

**输入格式**：
```
/auvima.recipe create "在<目标网站>上<执行操作>"
```

**示例**：
```
/auvima.recipe create "在YouTube视频页面提取完整字幕内容"
/auvima.recipe create "在GitHub仓库页面克隆README和项目信息"
/auvima.recipe create "在Twitter搜索页面收集最新20条推文"
```

**执行流程**：

1. **理解需求**
   - 提取平台/网站（youtube/github/twitter等）
   - 提取操作目标（提取字幕/克隆信息/收集推文）
   - 生成建议的配方名：`<平台>_<操作简述>.js`

2. **确认配方名**
   - 展示建议的文件名
   - 让用户确认或修改
   - 检查是否存在同名配方

3. **交互式探索**
   - 连接到CDP（确保Chrome已在9222端口运行）
   - 根据用户描述导航到目标页面
   - 执行探索性操作：
     - 截图展示当前页面
     - 询问用户下一步操作
     - 定位元素（如果失败，展示候选元素让用户选择）
     - 记录每一步操作和选择器
   - 最多3次澄清问询，确保理解准确

4. **生成配方**
   - 将探索过程转换为JavaScript代码
   - 包含：
     - DOM选择器
     - 等待逻辑（处理动态加载）
     - 错误处理
     - 结果提取和返回
   - 保存到 `src/auvima/recipes/<配方名>.js`

5. **生成知识文档**
   - 创建 `src/auvima/recipes/<配方名>.md`
   - 包含标准6章节：
     1. 功能描述（从用户原始需求提取）
     2. 使用方法（完整的命令行示例）
     3. 前置条件（需要已打开的页面、登录状态等）
     4. 预期输出（数据格式和示例）
     5. 注意事项（已知限制、脆弱的选择器等）
     6. 更新历史（初始为空）

6. **验证配方**
   - 在当前页面执行生成的配方
   - 确认输出符合预期
   - 如有问题，询问用户是否需要调整

### update - 更新现有配方

基于反馈改进已有配方。

**输入格式**：
```
/auvima.recipe update <配方名> "<问题描述或改进需求>"
```

**示例**：
```
/auvima.recipe update youtube_extract_subtitles "YouTube改版后字幕按钮的选择器失效了"
/auvima.recipe update github_clone_repo_info "需要增加提取star数和fork数"
```

**执行流程**：

1. 加载现有配方和知识文档
2. 理解问题或改进需求
3. 重新探索目标页面，定位新的元素或修复失效的选择器
4. 覆盖原配方文件（.js）
5. 在知识文档的"更新历史"章节添加条目：
   ```markdown
   ## 更新历史

   ### 2025-11-18
   - **原因**: YouTube改版导致字幕按钮选择器失效
   - **变更**: 更新按钮选择器从 `.old-selector` 改为 `.new-selector`
   - **测试**: 在最新版YouTube页面验证通过
   ```

### list - 列出所有配方

展示配方库中的所有可用配方。

**输出格式**：
```
📦 可用配方 (3个)

🔹 youtube_extract_subtitles
   功能: 提取YouTube视频完整字幕内容
   创建: 2025-11-15
   最后更新: 2025-11-18

🔹 github_clone_repo_info
   功能: 克隆GitHub仓库的README和项目元信息
   创建: 2025-11-16

🔹 twitter_collect_search_tweets
   功能: 从Twitter搜索页面收集最新推文
   创建: 2025-11-17
```

## 前置条件

- Chrome必须已通过CDP启动（端口9222）
- 可以通过 `uv run auvima status` 检查连接状态
- 对于需要登录的操作，用户应在探索前手动登录

## 配方命名规范

**格式**: `<平台>_<操作动词>_<对象>.js`

**平台缩写建议**:
- youtube - YouTube
- github - GitHub
- twitter - Twitter/X
- linkedin - LinkedIn
- reddit - Reddit
- bilibili - 哔哩哔哩
- zhihu - 知乎
- general - 通用网站（无特定平台）

**操作动词建议**:
- extract - 提取内容
- collect - 收集列表
- clone - 克隆/复制数据
- monitor - 监控变化
- analyze - 分析页面

## 探索失败处理

当探索过程中无法定位元素时：

1. **展示当前页面截图**
2. **列出候选元素**（如果能找到相似的）
3. **询问用户**：
   - "这是你想要点击的元素吗？"（展示候选列表）
   - "请描述元素的特征"（文本内容、位置、颜色等）
4. **最多3次交互**，如果仍无法定位：
   - 保存已探索到的部分信息
   - 建议用户重新整理需求或提供更多细节
   - 不生成不完整的配方

## 输出文件

```
src/auvima/recipes/
├── <平台>_<操作>_<对象>.js      # 可执行配方
└── <平台>_<操作>_<对象>.md      # 知识文档
```

## 使用生成的配方

```bash
# 执行配方
uv run auvima exec-js recipes/<配方名>.js

# 查看配方文档
cat src/auvima/recipes/<配方名>.md
```

## 注意事项

1. **配方的独立性**: 每个配方应该是自包含的，不依赖其他配方
2. **错误处理**: 生成的配方必须包含完善的错误处理，失败时返回清晰的错误信息
3. **等待策略**: 对于动态加载的内容，配方应包含适当的等待逻辑
4. **选择器稳定性**: 优先使用稳定的选择器（ARIA标签、data属性），并在文档中标注脆弱的选择器
5. **知识积累**: 将配方视为项目的知识资产，认真编写文档便于后续维护

## 实现脚本

本命令为Claude Code交互式命令，无需外部脚本实现。
